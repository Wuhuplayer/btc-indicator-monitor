#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
‰∏ì‰∏öÂèåÂêë‰∫§ÊòìÁ≥ªÁªü
ÁªìÂêà WaveTrend + Âä®Èáè + ADX + ‰ªì‰ΩçÁÆ°ÁêÜ
"""

import sys
import pandas as pd
import numpy as np
from pathlib import Path

sys.path.append(str(Path(__file__).parent / 'Ê®°Âùó'))
from Êï∞ÊçÆÊ®°Âùó import DataModule


def calculate_all_indicators(df):
    """ËÆ°ÁÆóÊâÄÊúâÊäÄÊúØÊåáÊ†á"""
    print("üìä ËÆ°ÁÆóÊäÄÊúØÊåáÊ†á...")
    df = df.copy()
    
    # 1. WaveTrendÔºàTradingViewÊ†áÂáÜÔºâ
    n1, n2 = 10, 21
    hlc3 = (df['high'] + df['low'] + df['close']) / 3
    esa = hlc3.ewm(span=n1, adjust=False).mean()
    d = (hlc3 - esa).abs().ewm(span=n1, adjust=False).mean()
    ci = (hlc3 - esa) / (0.015 * d)
    
    df['wt1'] = ci.ewm(span=n2, adjust=False).mean()
    df['wt2'] = df['wt1'].rolling(window=4).mean()
    
    # 2. Âä®ÈáèÊåáÊ†á
    mom_20d = df['close'].pct_change(20)
    df['momentum'] = (mom_20d - mom_20d.mean()) / mom_20d.std()
    df['momentum_raw'] = mom_20d * 100  # ÂéüÂßãÁôæÂàÜÊØî
    
    # 3. ADXÔºàË∂ãÂäøÂº∫Â∫¶Ôºâ
    period = 14
    high_diff = df['high'].diff()
    low_diff = -df['low'].diff()
    
    plus_dm = high_diff.where((high_diff > low_diff) & (high_diff > 0), 0)
    minus_dm = low_diff.where((low_diff > high_diff) & (low_diff > 0), 0)
    
    tr1 = df['high'] - df['low']
    tr2 = abs(df['high'] - df['close'].shift())
    tr3 = abs(df['low'] - df['close'].shift())
    tr = pd.concat([tr1, tr2, tr3], axis=1).max(axis=1)
    
    atr = tr.rolling(window=period).mean()
    df['plus_di'] = 100 * (plus_dm.rolling(window=period).mean() / atr)
    df['minus_di'] = 100 * (minus_dm.rolling(window=period).mean() / atr)
    
    dx = 100 * abs(df['plus_di'] - df['minus_di']) / (df['plus_di'] + df['minus_di'])
    df['adx'] = dx.rolling(window=period).mean()
    
    # 4. ÁßªÂä®Âπ≥ÂùáÁ∫øÔºàË∂ãÂäøÊñπÂêëÔºâ
    df['ma50'] = df['close'].rolling(window=50).mean()
    df['ma200'] = df['close'].rolling(window=200).mean()
    
    print("‚úÖ ÊåáÊ†áËÆ°ÁÆóÂÆåÊàê")
    return df


class ProfessionalTradingSystem:
    """‰∏ì‰∏öÂèåÂêë‰∫§ÊòìÁ≥ªÁªü"""
    
    def __init__(self, initial_capital=10000, stop_loss=0.10):
        self.initial_capital = initial_capital
        self.stop_loss = stop_loss
        
        # ‰ªì‰ΩçÈÖçÁΩÆ
        self.position_levels = {
            'light': 0.33,    # ËΩª‰ªì
            'medium': 0.66,   # ‰∏≠‰ªì
            'heavy': 0.95     # Èáç‰ªì
        }
    
    def determine_position_size(self, wt1, momentum, adx, direction='LONG'):
        """
        Ê†πÊçÆ‰ø°Âè∑Âº∫Â∫¶Á°ÆÂÆö‰ªì‰ΩçÂ§ßÂ∞è
        
        ‰ø°Âè∑Âº∫Â∫¶ÂàÜÁ∫ßÔºö
        - Âº∫‰ø°Âè∑ÔºöÈáç‰ªìÔºà95%Ôºâ
        - ‰∏≠Á≠â‰ø°Âè∑Ôºö‰∏≠‰ªìÔºà66%Ôºâ
        - Âº±‰ø°Âè∑ÔºöËΩª‰ªìÔºà33%Ôºâ
        """
        if direction == 'LONG':
            # ÂÅöÂ§ö‰ªì‰ΩçÂà§Êñ≠
            if wt1 < -60 and momentum > -0.3 and adx > 25:
                return self.position_levels['heavy'], 'Âº∫‰π∞ÂÖ•'
            elif wt1 < -50 and momentum > -0.5 and adx > 20:
                return self.position_levels['heavy'], 'Âº∫‰π∞ÂÖ•'
            elif wt1 < -50 and momentum > -0.5:
                return self.position_levels['medium'], '‰∏≠Á≠â‰π∞ÂÖ•'
            elif wt1 < -40 and momentum > -0.3:
                return self.position_levels['light'], 'ËΩªÂ∫¶‰π∞ÂÖ•'
            else:
                return 0, '‰∏ç‰π∞ÂÖ•'
        
        else:  # direction == 'SHORT'
            # ÂÅöÁ©∫‰ªì‰ΩçÂà§Êñ≠
            if wt1 > 60 and momentum < 0.3 and adx > 25:
                return self.position_levels['heavy'], 'Âº∫ÂÅöÁ©∫'
            elif wt1 > 50 and momentum < 0.5 and adx > 20:
                return self.position_levels['medium'], '‰∏≠Á≠âÂÅöÁ©∫'
            elif wt1 > 40 and momentum < 0.3:
                return self.position_levels['light'], 'ËΩªÂ∫¶ÂÅöÁ©∫'
            else:
                return 0, '‰∏çÂÅöÁ©∫'
    
    def should_close_long(self, wt1, wt2, prev_wt1, prev_wt2, momentum, adx):
        """Âà§Êñ≠ÊòØÂê¶Âπ≥Â§ö‰ªì"""
        death_cross = (wt1 < wt2) and (prev_wt1 >= prev_wt2)
        
        # Âπ≥Â§öÊù°‰ª∂
        if death_cross and wt1 > 0 and adx > 20:
            return True, 'ADX>20‰∏îWTÊ≠ªÂèâ'
        elif wt1 > 70:
            return True, 'WTÊûÅÂ∫¶Ë∂Ö‰π∞'
        elif momentum < -0.8:
            return True, 'Âä®Èáè‰∏•ÈáçËΩ¨Ë¥ü'
        
        return False, ''
    
    def should_close_short(self, wt1, wt2, prev_wt1, prev_wt2, momentum, adx):
        """Âà§Êñ≠ÊòØÂê¶Âπ≥Á©∫‰ªì"""
        golden_cross = (wt1 > wt2) and (prev_wt1 <= prev_wt2)
        
        # Âπ≥Á©∫Êù°‰ª∂
        if golden_cross and wt1 < -20:
            return True, 'WTÈáëÂèâ'
        elif wt1 < -70:
            return True, 'WTÊûÅÂ∫¶Ë∂ÖÂçñ'
        elif momentum > 0.8:
            return True, 'Âä®ÈáèÂº∫ÂäøËΩ¨Ê≠£'
        
        return False, ''
    
    def run_backtest(self, df):
        """ËøêË°åÂÆåÊï¥ÂõûÊµã"""
        print()
        print("=" * 100)
        print("üöÄ ‰∏ì‰∏öÂèåÂêë‰∫§ÊòìÁ≥ªÁªüÂõûÊµã")
        print("=" * 100)
        print()
        
        cash = self.initial_capital
        position = 0  # Ê≠£=ÂÅöÂ§öÔºåË¥ü=ÂÅöÁ©∫
        entry_price = 0
        entry_date = None
        position_type = None
        position_size_name = ''
        
        trades = []
        portfolio = []
        
        for i in range(1, len(df)):
            row = df.iloc[i]
            prev = df.iloc[i-1]
            date = row['date']
            price = row['close']
            
            # ËÆ°ÁÆóÂΩìÂâçÊÄª‰ª∑ÂÄº
            if position > 0:  # ÂÅöÂ§ö
                total_value = cash + position * price
            elif position < 0:  # ÂÅöÁ©∫
                unrealized_pnl = -position * (entry_price - price)
                total_value = cash + unrealized_pnl
            else:
                total_value = cash
            
            # === Ê≠¢ÊçüÊ£ÄÊü• ===
            if position != 0:
                if position > 0:  # ÂÅöÂ§öÊ≠¢Êçü
                    loss_pct = (entry_price - price) / entry_price
                    if loss_pct >= self.stop_loss:
                        pnl = position * (price - entry_price)
                        trades.append({
                            'entry_date': entry_date,
                            'exit_date': date,
                            'type': 'LONG',
                            'position_size': position_size_name,
                            'entry_price': entry_price,
                            'exit_price': price,
                            'pnl': pnl,
                            'pnl_pct': pnl / (position * entry_price) * 100,
                            'reason': f'Ê≠¢Êçü-{loss_pct*100:.1f}%'
                        })
                        cash += position * price
                        position = 0
                        entry_price = 0
                        position_type = None
                
                elif position < 0:  # ÂÅöÁ©∫Ê≠¢Êçü
                    loss_pct = (price - entry_price) / entry_price
                    if loss_pct >= self.stop_loss:
                        pnl = -position * (entry_price - price)
                        trades.append({
                            'entry_date': entry_date,
                            'exit_date': date,
                            'type': 'SHORT',
                            'position_size': position_size_name,
                            'entry_price': entry_price,
                            'exit_price': price,
                            'pnl': pnl,
                            'pnl_pct': pnl / (-position * entry_price) * 100,
                            'reason': f'Ê≠¢Êçü-{loss_pct*100:.1f}%'
                        })
                        cash += pnl
                        position = 0
                        entry_price = 0
                        position_type = None
            
            # === Âπ≥‰ªì‰ø°Âè∑ ===
            if position > 0:  # Ê£ÄÊü•ÊòØÂê¶Âπ≥Â§ö
                should_close, reason = self.should_close_long(
                    row['wt1'], row['wt2'], prev['wt1'], prev['wt2'],
                    row['momentum'], row['adx']
                )
                if should_close:
                    pnl = position * (price - entry_price)
                    trades.append({
                        'entry_date': entry_date,
                        'exit_date': date,
                        'type': 'LONG',
                        'position_size': position_size_name,
                        'entry_price': entry_price,
                        'exit_price': price,
                        'pnl': pnl,
                        'pnl_pct': pnl / (position * entry_price) * 100,
                        'reason': reason
                    })
                    cash += position * price
                    position = 0
                    entry_price = 0
                    position_type = None
            
            elif position < 0:  # Ê£ÄÊü•ÊòØÂê¶Âπ≥Á©∫
                should_close, reason = self.should_close_short(
                    row['wt1'], row['wt2'], prev['wt1'], prev['wt2'],
                    row['momentum'], row['adx']
                )
                if should_close:
                    pnl = -position * (entry_price - price)
                    trades.append({
                        'entry_date': entry_date,
                        'exit_date': date,
                        'type': 'SHORT',
                        'position_size': position_size_name,
                        'entry_price': entry_price,
                        'exit_price': price,
                        'pnl': pnl,
                        'pnl_pct': pnl / (-position * entry_price) * 100,
                        'reason': reason
                    })
                    cash += pnl
                    position = 0
                    entry_price = 0
                    position_type = None
            
            # === ÂºÄ‰ªì‰ø°Âè∑ÔºàÂè™Âú®Á©∫‰ªìÊó∂Ôºâ ===
            if position == 0:
                golden_cross = (row['wt1'] > row['wt2']) and (prev['wt1'] <= prev['wt2'])
                death_cross = (row['wt1'] < row['wt2']) and (prev['wt1'] >= prev['wt2'])
                
                # ÂÅöÂ§ö‰ø°Âè∑
                if golden_cross:
                    pos_size, size_name = self.determine_position_size(
                        row['wt1'], row['momentum'], row['adx'], 'LONG'
                    )
                    
                    if pos_size > 0:
                        buy_value = total_value * pos_size
                        position = buy_value / price
                        cash = total_value - buy_value
                        entry_price = price
                        entry_date = date
                        position_type = 'LONG'
                        position_size_name = size_name
                
                # ÂÅöÁ©∫‰ø°Âè∑
                elif death_cross:
                    pos_size, size_name = self.determine_position_size(
                        row['wt1'], row['momentum'], row['adx'], 'SHORT'
                    )
                    
                    if pos_size > 0:
                        short_value = total_value * pos_size
                        position = -short_value / price  # Ë¥üÊï∞Ë°®Á§∫ÂÅöÁ©∫
                        entry_price = price
                        entry_date = date
                        position_type = 'SHORT'
                        position_size_name = size_name
            
            # ËÆ∞ÂΩïÁªÑÂêà‰ª∑ÂÄº
            if position > 0:
                total_value = cash + position * price
            elif position < 0:
                unrealized_pnl = -position * (entry_price - price)
                total_value = cash + unrealized_pnl
            else:
                total_value = cash
            
            portfolio.append({
                'date': date,
                'price': price,
                'total_value': total_value,
                'position': position,
                'position_type': position_type
            })
        
        # ÊúÄÁªà‰ªì‰Ωç
        final_price = df.iloc[-1]['close']
        if position > 0:
            pnl = position * (final_price - entry_price)
            print(f"\n‚ö†Ô∏è  ÊúÄÁªàÂÅöÂ§ö‰ªì‰Ωç: {position:.6f} BTC")
            print(f"   ÂÖ•Âú∫: {entry_date} @ ${entry_price:,.0f} ({position_size_name})")
            print(f"   ÂΩìÂâç: ${final_price:,.0f}")
            print(f"   ÊµÆÂä®Áõà‰∫è: ${pnl:,.0f} ({pnl/(position*entry_price)*100:+.1f}%)")
        elif position < 0:
            pnl = -position * (entry_price - final_price)
            print(f"\n‚ö†Ô∏è  ÊúÄÁªàÂÅöÁ©∫‰ªì‰Ωç: {-position:.6f} BTC")
            print(f"   ÂÖ•Âú∫: {entry_date} @ ${entry_price:,.0f} ({position_size_name})")
            print(f"   ÂΩìÂâç: ${final_price:,.0f}")
            print(f"   ÊµÆÂä®Áõà‰∫è: ${pnl:,.0f} ({pnl/(-position*entry_price)*100:+.1f}%)")
        
        portfolio_df = pd.DataFrame(portfolio)
        trades_df = pd.DataFrame(trades) if trades else pd.DataFrame()
        
        return portfolio_df, trades_df
    
    def show_results(self, portfolio_df, trades_df, strategy_name):
        """ÊòæÁ§∫ÂõûÊµãÁªìÊûú"""
        print()
        print("=" * 100)
        print(f"üìä {strategy_name} - ÂõûÊµãÁªìÊûú")
        print("=" * 100)
        print()
        
        final = portfolio_df['total_value'].iloc[-1]
        ret = (final - self.initial_capital) / self.initial_capital * 100
        
        portfolio_df['peak'] = portfolio_df['total_value'].cummax()
        portfolio_df['dd'] = (portfolio_df['total_value'] - portfolio_df['peak']) / portfolio_df['peak'] * 100
        max_dd = portfolio_df['dd'].min()
        
        print(f"üí∞ ÂàùÂßãËµÑÈáë: ${self.initial_capital:,.0f}")
        print(f"üí∞ ÊúÄÁªà‰ª∑ÂÄº: ${final:,.0f}")
        print(f"üìà ÊÄªÊî∂ÁõäÁéá: {ret:+.2f}%")
        print(f"üìâ ÊúÄÂ§ßÂõûÊí§: {max_dd:.2f}%")
        print()
        
        if len(trades_df) > 0:
            long_trades = trades_df[trades_df['type'] == 'LONG']
            short_trades = trades_df[trades_df['type'] == 'SHORT']
            
            print(f"üìä ‰∫§ÊòìÁªüËÆ°:")
            print(f"  ÊÄª‰∫§ÊòìÊ¨°Êï∞: {len(trades_df)}Ê¨°")
            print(f"    üü¢ ÂÅöÂ§ö: {len(long_trades)}Ê¨°")
            print(f"    üî¥ ÂÅöÁ©∫: {len(short_trades)}Ê¨°")
            print()
            
            # ÂÅöÂ§öÁªüËÆ°
            if len(long_trades) > 0:
                long_win = long_trades[long_trades['pnl'] > 0]
                long_loss = long_trades[long_trades['pnl'] < 0]
                long_win_rate = len(long_win) / len(long_trades) * 100
                
                print(f"  üü¢ ÂÅöÂ§öËØ¶ÊÉÖ:")
                print(f"    ËÉúÁéá: {long_win_rate:.1f}%")
                print(f"    ÊÄªÁõà‰∫è: ${long_trades['pnl'].sum():,.0f}")
                if len(long_win) > 0:
                    print(f"    Âπ≥ÂùáÁõàÂà©: ${long_win['pnl'].mean():,.0f} ({long_win['pnl_pct'].mean():+.1f}%)")
                if len(long_loss) > 0:
                    print(f"    Âπ≥Âùá‰∫èÊçü: ${long_loss['pnl'].mean():,.0f} ({long_loss['pnl_pct'].mean():.1f}%)")
                print()
            
            # ÂÅöÁ©∫ÁªüËÆ°
            if len(short_trades) > 0:
                short_win = short_trades[short_trades['pnl'] > 0]
                short_loss = short_trades[short_trades['pnl'] < 0]
                short_win_rate = len(short_win) / len(short_trades) * 100
                
                print(f"  üî¥ ÂÅöÁ©∫ËØ¶ÊÉÖ:")
                print(f"    ËÉúÁéá: {short_win_rate:.1f}%")
                print(f"    ÊÄªÁõà‰∫è: ${short_trades['pnl'].sum():,.0f}")
                if len(short_win) > 0:
                    print(f"    Âπ≥ÂùáÁõàÂà©: ${short_win['pnl'].mean():,.0f} ({short_win['pnl_pct'].mean():+.1f}%)")
                if len(short_loss) > 0:
                    print(f"    Âπ≥Âùá‰∫èÊçü: ${short_loss['pnl'].mean():,.0f} ({short_loss['pnl_pct'].mean():.1f}%)")
                print()
            
            # Êï¥‰ΩìËÉúÁéá
            win_trades = trades_df[trades_df['pnl'] > 0]
            overall_win_rate = len(win_trades) / len(trades_df) * 100
            
            print(f"  üéØ Êï¥‰ΩìËÉúÁéá: {overall_win_rate:.1f}%")
            print(f"  üí∞ Â∑≤ÂÆûÁé∞Áõà‰∫è: ${trades_df['pnl'].sum():,.0f}")
            
            # Áõà‰∫èÊØî
            if len(win_trades) > 0 and len(trades_df[trades_df['pnl'] < 0]) > 0:
                avg_win = win_trades['pnl'].mean()
                avg_loss = abs(trades_df[trades_df['pnl'] < 0]['pnl'].mean())
                profit_factor = avg_win / avg_loss
                print(f"  üìä Áõà‰∫èÊØî: {profit_factor:.2f}")
        
        print()
        print("=" * 100)
        
        return {
            'strategy': strategy_name,
            'return': ret,
            'max_dd': max_dd,
            'trades': len(trades_df),
            'win_rate': overall_win_rate if len(trades_df) > 0 else 0
        }


def main():
    print("=" * 100)
    print("üéØ ‰∏ì‰∏öÂèåÂêë‰∫§ÊòìÁ≥ªÁªüÔºàWT + Âä®Èáè + ADX + ‰ªì‰ΩçÁÆ°ÁêÜÔºâ")
    print("=" * 100)
    print()
    
    # Âä†ËΩΩÊï∞ÊçÆ
    print("„ÄêÊ≠•È™§1„ÄëÂä†ËΩΩÊï∞ÊçÆ...")
    data_module = DataModule()
    df = data_module.get_price_data()
    print()
    
    # ËÆ°ÁÆóÊåáÊ†á
    print("„ÄêÊ≠•È™§2„ÄëËÆ°ÁÆóÊäÄÊúØÊåáÊ†á...")
    df = calculate_all_indicators(df)
    print()
    
    # ËøêË°åÂõûÊµã
    print("„ÄêÊ≠•È™§3„ÄëËøêË°å‰∏ì‰∏öÂèåÂêë‰∫§ÊòìÁ≥ªÁªü...")
    
    system = ProfessionalTradingSystem(initial_capital=10000, stop_loss=0.10)
    portfolio_df, trades_df = system.run_backtest(df)
    result = system.show_results(portfolio_df, trades_df, "‰∏ì‰∏öÂèåÂêë‰∫§ÊòìÁ≥ªÁªü")
    
    # ÂØπÊØî‰π∞ÂÖ•ÊåÅÊúâ
    print()
    print("„ÄêÊ≠•È™§4„ÄëÂØπÊØî‰π∞ÂÖ•ÊåÅÊúâ...")
    print("=" * 100)
    
    start_price = df.iloc[0]['close']
    end_price = df.iloc[-1]['close']
    hold_return = (end_price / start_price - 1) * 100
    
    print()
    print(f"üìä ÊúÄÁªàÂØπÊØî:")
    print(f"  ‰π∞ÂÖ•ÊåÅÊúâ: {hold_return:+.2f}%")
    print(f"  ÂèåÂêë‰∫§Êòì: {result['return']:+.2f}%")
    print(f"  Â∑ÆË∑ù: {result['return'] - hold_return:+.2f}%")
    print()
    
    if result['return'] > hold_return:
        print(f"üéâ ÊÅ≠ÂñúÔºÅÂèåÂêë‰∫§ÊòìË∂ÖË∂ä‰π∞ÂÖ•ÊåÅÊúâ {result['return'] - hold_return:+.2f}%ÔºÅ")
    else:
        print(f"‚ö†Ô∏è  ÂèåÂêë‰∫§ÊòìË∑ëËæì‰π∞ÂÖ•ÊåÅÊúâ {hold_return - result['return']:.2f}%")
        print(f"   ‰ΩÜÂõûÊí§‰ºòÂäø: {result['max_dd']:.2f}% vs -81.00%")
    
    print()
    print("=" * 100)
    
    # ÊòæÁ§∫‰∫§ÊòìÊòéÁªÜ
    if len(trades_df) > 0:
        print()
        print("üìã ‰∫§ÊòìÊòéÁªÜÔºàÂâç20Á¨îÔºâ:")
        print()
        print(trades_df[['entry_date', 'exit_date', 'type', 'position_size', 
                         'entry_price', 'exit_price', 'pnl_pct', 'reason']].head(20).to_string(index=False))
    
    # ‰øùÂ≠òÁªìÊûú
    portfolio_df.to_csv('Êï∞Â≠óÂåñÊï∞ÊçÆ/professional_portfolio.csv', index=False, encoding='utf-8-sig')
    if len(trades_df) > 0:
        trades_df.to_csv('Êï∞Â≠óÂåñÊï∞ÊçÆ/professional_trades.csv', index=False, encoding='utf-8-sig')
    
    print()
    print()
    print("‚úÖ ÁªìÊûúÂ∑≤‰øùÂ≠ò:")
    print("  ‚Ä¢ Êï∞Â≠óÂåñÊï∞ÊçÆ/professional_portfolio.csv")
    print("  ‚Ä¢ Êï∞Â≠óÂåñÊï∞ÊçÆ/professional_trades.csv")
    print()
    print("=" * 100)


if __name__ == "__main__":
    main()

